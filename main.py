import streamlit as st
import pandas as pd

# ì—´ ì´ë¦„ ì •ë¦¬ í•¨ìˆ˜
def ì •ì œ_ì—´ì´ë¦„(df, ì ‘ë‘ì‚¬):
    ìƒˆë¡œìš´_ì—´ = []
    for ì—´ in df.columns:
        if ì—´.startswith(ì ‘ë‘ì‚¬):
            label = ì—´.replace(ì ‘ë‘ì‚¬, '')
            if 'ì´ì¸êµ¬ìˆ˜' in label:
                ìƒˆë¡œìš´_ì—´.append('ì´ì¸êµ¬ìˆ˜')
            elif 'ì—°ë ¹êµ¬ê°„ì¸êµ¬ìˆ˜' in label:
                ìƒˆë¡œìš´_ì—´.append('ì—°ë ¹êµ¬ê°„ì¸êµ¬ìˆ˜')
            else:
                ìƒˆë¡œìš´_ì—´.append(label)
        else:
            ìƒˆë¡œìš´_ì—´.append(ì—´)
    df.columns = ìƒˆë¡œìš´_ì—´
    return df

# ìˆ«ìí˜• ë³€í™˜ í•¨ìˆ˜
def ìˆ«ì_í˜•ë³€í™˜(df):
    ìˆ«ìì—´ = [ì—´ for ì—´ in df.columns if ì—´ != 'í–‰ì •êµ¬ì—­']
    for ì—´ in ìˆ«ìì—´:
        df[ì—´] = df[ì—´].astype(str).str.replace(',', '', regex=False).astype(int)
    return df

def app():
    st.title("ğŸ“Š ëŒ€í•œë¯¼êµ­ ì—°ë ¹ëŒ€ë³„ ì¸êµ¬ ë¶„í¬ (ìƒìœ„ 5ê°œ í–‰ì •êµ¬ì—­ ê¸°ì¤€)")

    # 1. ì „ì²´ ì¸êµ¬ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
    df_ì „ì²´ = pd.read_csv('202505_202505_ì—°ë ¹ë³„ì¸êµ¬í˜„í™©_ì›”ê°„.csv', encoding='euc-kr')
    df_ì „ì²´['í–‰ì •êµ¬ì—­'] = df_ì „ì²´['í–‰ì •êµ¬ì—­'].astype(str).str.split(' ').str[0]
    df_ì „ì²´ = ì •ì œ_ì—´ì´ë¦„(df_ì „ì²´, '2025ë…„05ì›”_ê³„_')
    df_ì „ì²´ = ìˆ«ì_í˜•ë³€í™˜(df_ì „ì²´)

    # 2. ì„±ë³„ ì¸êµ¬ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
    df_ì„±ë³„ = pd.read_csv('202505_202505_ì—°ë ¹ë³„ì¸êµ¬í˜„í™©_ì›”ê°„ (1).csv', encoding='euc-kr')
    df_ì„±ë³„['í–‰ì •êµ¬ì—­'] = df_ì„±ë³„['í–‰ì •êµ¬ì—­'].astype(str).str.split(' ').str[0]

    ì—´ëª©ë¡ = []
    for ì—´ in df_ì„±ë³„.columns:
        if ì—´.startswith('2025ë…„05ì›”_ë‚¨_'):
            ì—´ëª©ë¡.append('ë‚¨_' + ì—´.replace('2025ë…„05ì›”_ë‚¨_', ''))
        elif ì—´.startswith('2025ë…„05ì›”_ì—¬_'):
            ì—´ëª©ë¡.append('ì—¬_' + ì—´.replace('2025ë…„05ì›”_ì—¬_', ''))
        else:
            ì—´ëª©ë¡.append(ì—´)
    df_ì„±ë³„.columns = ì—´ëª©ë¡
    df_ì„±ë³„ = ìˆ«ì_í˜•ë³€í™˜(df_ì„±ë³„)

    # 3. ì´ì¸êµ¬ ê¸°ì¤€ ìƒìœ„ 5ê°œ í–‰ì •êµ¬ì—­ ì¶”ì¶œ
    ìƒìœ„5 = df_ì „ì²´.sort_values(by='ì´ì¸êµ¬ìˆ˜', ascending=False).head(5)['í–‰ì •êµ¬ì—­'].tolist()
    df_ì „ì²´_ìƒìœ„5 = df_ì „ì²´[df_ì „ì²´['í–‰ì •êµ¬ì—­'].isin(ìƒìœ„5)].copy()
    df_ì„±ë³„_ìƒìœ„5 = df_ì„±ë³„[df_ì„±ë³„['í–‰ì •êµ¬ì—­'].isin(ìƒìœ„5)].copy()

    # 4. ì „ì²´ ì¸êµ¬ ì‹œê°í™”
    st.subheader("ğŸ”¹ ìƒìœ„ 5ê°œ í–‰ì •êµ¬ì—­ì˜ ì—°ë ¹ëŒ€ë³„ ì´ì¸êµ¬ ë¶„í¬")
    df_ì „ì²´_ë³€í™˜ = df_ì „ì²´_ìƒìœ„5.melt(
        id_vars=['í–‰ì •êµ¬ì—­', 'ì´ì¸êµ¬ìˆ˜', 'ì—°ë ¹êµ¬ê°„ì¸êµ¬ìˆ˜'],
        var_name='ì—°ë ¹',
        value_name='ì¸êµ¬ìˆ˜'
    )
    df_ì „ì²´_ë³€í™˜['ì—°ë ¹'] = df_ì „ì²´_ë³€í™˜['ì—°ë ¹'].str.extract(r'(\d+)')
    df_ì „ì²´_ë³€í™˜ = df_ì „ì²´_ë³€í™˜.dropna(subset=['ì—°ë ¹'])
    df_ì „ì²´_ë³€í™˜['ì—°ë ¹'] = df_ì „ì²´_ë³€í™˜['ì—°ë ¹'].astype(int)
    í”¼ë²—_ì „ì²´ = df_ì „ì²´_ë³€í™˜.pivot_table(index='ì—°ë ¹', columns='í–‰ì •êµ¬ì—­', values='ì¸êµ¬ìˆ˜')
    st.line_chart(í”¼ë²—_ì „ì²´)

    # 5. ì„±ë³„ ì¸êµ¬ ì‹œê°í™”
    st.subheader("ğŸ”¹ ìƒìœ„ 5ê°œ í–‰ì •êµ¬ì—­ì˜ ì—°ë ¹ëŒ€ë³„ ì„±ë³„ ì¸êµ¬ ë¶„í¬")
    ì„±ë³„_ì„ íƒ = st.radio("ì„±ë³„ ì„ íƒ", options=['ë‚¨', 'ì—¬'], horizontal=True)

    # 'ë‚¨_00' ë˜ëŠ” 'ì—¬_00' ì—´ë§Œ í•„í„°ë§
    ì„ íƒì—´ = [ì—´ for ì—´ in df_ì„±ë³„_ìƒìœ„5.columns if ì—´.startswith(ì„±ë³„_ì„ íƒ + '_') and ì—´.replace(ì„±ë³„_ì„ íƒ + '_', '').isdigit()]
    df_ì„ íƒ = df_ì„±ë³„_ìƒìœ„5[['í–‰ì •êµ¬ì—­'] + ì„ íƒì—´].copy()

    df_ì„±ë³„ë³€í™˜ = df_ì„ íƒ.melt(id_vars=['í–‰ì •êµ¬ì—­'],
                             var_name='ì—°ë ¹',
                             value_name='ì¸êµ¬ìˆ˜')
    df_ì„±ë³„ë³€í™˜['ì—°ë ¹'] = df_ì„±ë³„ë³€í™˜['ì—°ë ¹'].str.extract(r'(\d+)')
    df_ì„±ë³„ë³€í™˜ = df_ì„±ë³„ë³€í™˜.dropna(subset=['ì—°ë ¹'])
    df_ì„±ë³„ë³€í™˜['ì—°ë ¹'] = df_ì„±ë³„ë³€í™˜['ì—°ë ¹'].astype(int)
    í”¼ë²—_ì„±ë³„ = df_ì„±ë³„ë³€í™˜.pivot_table(index='ì—°ë ¹', columns='í–‰ì •êµ¬ì—­', values='ì¸êµ¬ìˆ˜')
    st.line_chart(í”¼ë²—_ì„±ë³„)

    # 6. ì›ë³¸ ë°ì´í„° ë³´ê¸°
    with st.expander("ğŸ“„ ì›ë³¸ ë°ì´í„° ë³´ê¸°"):
        st.write("ì „ì²´ ì¸êµ¬ ë°ì´í„°")
        st.dataframe(df_ì „ì²´)
        st.write("ì„±ë³„ ì¸êµ¬ ë°ì´í„°")
        st.dataframe(df_ì„±ë³„)

if __name__ == '__main__':
    app()

